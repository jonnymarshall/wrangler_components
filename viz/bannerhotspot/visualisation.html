<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced collection grid</title>
    <link href="../../assets/css/app.css?v=5" rel="stylesheet" type="text/css"/>
    <link href="../../assets/css/app.css?v=5" rel="stylesheet" type="text/css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1">

<script>
var BASE_URL = 'https://www.kilpling.com/uk-en/';

</script>
<script type="text/javascript" src="https://www.kipling.com/media/js/07ff614c37ab9d77960b77cf8a84e99d.js"></script>
<script type="text/javascript" src="https://www.kipling.com/media/js/7f091880b4818b2afcb947b821083199.js" 1000></script>
<script type="text/javascript" src="https://www.kipling.com/media/js/ee77b4194a3bdc208b6275e85679f6af.js" 1001></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
    </style>
</head>
<body>

<div class="grid-container">
      <div class="grid-x">
        <div class="cell">

            <div class="compo-module">
                <div class="full-bleed">
                    <div class="js_wrap"></div>
                </div>
            </div>

            <div style="height:2000px"></div>

        </div>

    </div>
</div>





<script src="../../assets/jsplugins/amp-js/cms-javascript-sdk.min.js"></script>
<script src="../../assets/jsplugins/amp-js/utils.js"></script>
<script src="https://code.jquery.com/jquery-1.8.3.min.js" integrity="sha256-YcbK69I5IXQftf/mYD8WY0/KmEDCv1asggHpJk1trM8=" crossorigin="anonymous"></script>
<script src="../../assets/jsplugins/o-dc-components.js"></script>

<script>
    function getQueryVar(params) {
        var paramsObj = {};
        var currentParam = null;
        for (var x = 0; x < params.length; x++) {
            currentParam = window.location.href.match(new RegExp(params[x] + "=([a-zA-Z0-9-\._]+)"));
            if (currentParam && currentParam.length > 1) {
                paramsObj[params[x]] = currentParam[1];
            }
            else {
                console.warn('Param: ' + x + ' not found');
            }
        }
        return paramsObj;
    }
    //AmpCa is global namespace generated by handlebars compiler
    AmpCa.utils = new AmpCa.Utils();
    var parsedParams = getQueryVar(['api', 'content', 'temp']);
    console.log(parsedParams);
    AmpCa.utils.getHtmlServiceData({
        auth: {
            baseUrl: ('//' + parsedParams['api']),
            id: parsedParams['content'],
            store: 'kipling',
            templateName: parsedParams['temp']
        },
        callback: function (data) {
            //console.log(data);
            document.querySelectorAll(".js_wrap")[0].innerHTML = data;
            //AmpCa.utils.postProcessing.execHtmlService('card-json', {});
            

            // Hotspot code start
            // Example proxy JavaScript function. This just sends the target ( sku ) as an alert
            



jQuery( ".bannerhotspot-container" ).each(function() {

  // Step 1: Load the data - same URL as image ut
  var $imgTitle = jQuery(this).attr('id');
  var $imgUrl = jQuery('img.has-poi-meta').attr('src');

  //console.log($imgTitle + " " + $imgUrl);

  jQuery.ajax({url: "https:"+$imgUrl+".json?metadata=true&v=3", success: function(data){
    // We need the original image size - size of media being displayed / original size of the media.
    var ratio = 1000 / data.width;

    // Lets find the hotspots first
      if( data && data.metadata && data.metadata.hotSpots){
        if( (data.metadata.hotSpots.hasPoint ||  data.metadata.hotSpots.hasPolygon) && data.metadata.hotSpots.hotSpots.list){
          var hotspots = data.metadata.hotSpots.hotSpots.list;
          var newwidth = data.width * ratio;
          var newheight = data.height * ratio;
          var hotspotsOffset = 21;
          // Is there a polygon in the data? If so, create a map container
          if( data.metadata.hotSpots.hasPolygon ){
              $("#"+$imgTitle+".bannerhotspot-container").append("<svg id='hotspot-img-map' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 "+ newwidth +" "+ newheight +"' >");
          }
          // Go through the hotspots
          for( var i=0; i< hotspots.length; i++){
            var hotspot = hotspots[i];
            // Check for a type
            if( hotspot.points.x && hotspot.points.y){
              // This is a hotspot
              var newx = Math.round(hotspot.points.x * 100);
              var newy = Math.round(hotspot.points.y * 100);

              // Check for the selector in meta data and add it to the class of the DIV for the hotspot
              var spotclass = 'spot';
              if( hotspot.selector){
                  spotclass += " " + hotspot.selector;
              }

              $("#"+$imgTitle+".bannerhotspot-container").append("<div class='" + spotclass +"' style='left: calc(" + newx + "% - "+ hotspotsOffset +"px); top: calc(" + newy + "% - " + hotspotsOffset + "px);'><a class='btn' href='#' onclick='event.preventDefault(); doAmplienceAction(\"" + hotspot.target + "\")' title='" + hotspot.selector + "'>+</a></div>");
            } else {
                
              // This is a polygon
              var coords = "";
              for( var j=0; j < hotspot.points.length; j++ ){
                  coords += Math.round(newwidth * hotspot.points[j].x)+ "," + Math.round(newheight * hotspot.points[j].y) + ",";
              }
              coords = coords.substring(0, coords.length-1);
              var str = ""+"<polygon points=" + coords + " href='#' onclick='event.preventDefault(); doAmplienceAction(\"" + hotspot.target + "\")' title='" + hotspot.target + "'>";

              $('#'+$imgTitle+' #hotspot-img-map').append(str).html($('#'+$imgTitle+' #hotspot-img-map').html());
            }   
          }
        }
      }
    }, error: function(args){
      // Get a proper error state
      //console.log("Error");
    }
  }); 
});







        }
    });


    loryHelpers.initSliders(document.querySelectorAll(".js_slider"));

    function doAmplienceAction(sku){
  //alert(sku);
  //window.open(sku, '_parent');
  console.log('hotspot');
  openQuickBuyAMP(sku);
  
};

function openQuickBuyAMP(id,url){
  this.url=url?url:BASE_URL+"quickbuy/index/show/entity_id/"+id+"/?include_configurable_js=1";
  this.quickBuyContainer=jQuery(".quick-buy-form._active").length?jQuery(".quick-buy-form._active"):jQuery("#"+id);

  if(!this.quickBuyContainer.length){
    this.quickBuyContainer=jQuery('<div id="showQuickbuyForm'+id+'" class="quick-buy-form"></div>').appendTo("body")
  }

  this.quickBuyContainer.empty();
  jQuery("body").trigger("closeQuickBuyAMP");
  jQuery(".fader").addClass("active");
  this.quickBuyContainer.html('<div class="preloader"><h3>Quick Buy loading</h3></div>').addClass("_active");

  new Ajax.Request(this.url,{
    method:"get",onComplete:function(transport,json){
      jQuery(this.quickBuyContainer).html(transport.responseText);
      jQuery(".quick-buy-close",this.quickBuyContainer).prop("onclick",null).off("click").on("click",function(event){
        event.preventDefault();
        jQuery(this.quickBuyContainer).empty().removeClass("_active");
        jQuery("body").trigger("closeQuickBuyAMP");
        jQuery(".fader").removeClass("active")
      }.bind(this))
    }
  });return false
}

function closeQuickBuyAMP(){
  jQuery(".quick-buy-form").hide().removeClass("_active");
  jQuery(".quick-buy-form").empty();
  jQuery("body").trigger("closeQuickBuyAMP");
  jQuery(".quick-buy-form .product-color").remove()
}

var BASE_URL = 'https://www.kilpling.com/uk-en/';


    
</script>



</body>
</html>
